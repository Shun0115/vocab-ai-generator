<!doctype html>
<html>
<head>
    <title>å˜èªå¸³ç”ŸæˆAI</title>
    <meta charset="utf-8">
</head>
<script>
function speak(text) {
    // æ•°å­—ã ã‘ã®å ´åˆã¯å†ç”Ÿã—ãªã„
    if (/^\d+$/.test(text)) {
        return;
    }

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US'; // è‹±èªç™ºéŸ³

    // ã‚ˆã‚Šè‡ªç„¶ãªå£°ã‚’é¸æŠï¼ˆå¥³æ€§ã®å£°ãªã©ï¼‰
    const voices = window.speechSynthesis.getVoices();
    const preferredVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Female')) 
                        || voices.find(v => v.lang === 'en-US');
    if (preferredVoice) {
        utterance.voice = preferredVoice;
    }

    utterance.rate = 0.9; // ã‚†ã£ãã‚Šã‚ã§è‡ªç„¶ã«
    utterance.pitch = 1.0; // æ™®é€šã®é«˜ã•

    window.speechSynthesis.speak(utterance);
}
</script>
<script>
let voices = [];

// iOSã§ã¯ getVoices() ã®åæ˜ ãŒé…ã„ã“ã¨ãŒã‚ã‚‹ã®ã§ã€æ˜ç¤ºçš„ã«å‘¼ã¶
window.speechSynthesis.onvoiceschanged = () => {
    voices = window.speechSynthesis.getVoices();
};

function speak(text) {
    // æ•°å­—ã®ã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
    if (/^\d+$/.test(text)) return;

    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US'; // ğŸ‡ºğŸ‡¸ è‹±èªç™ºéŸ³

    // iOSã§ã¯ voice.name ã®æŒ‡å®šãŒåŠ¹ã‹ãªã„å ´åˆãŒã‚ã‚‹ã®ã§ã€langå„ªå…ˆã§è¨­å®š
    const enVoice = voices.find(v => v.lang === 'en-US');

    if (enVoice) {
        utterance.voice = enVoice;
    }

    utterance.rate = 0.9;   // å†ç”Ÿé€Ÿåº¦ï¼ˆã‚†ã£ãã‚Šã‚ï¼‰
    utterance.pitch = 1.0;  // å£°ã®é«˜ã•ï¼ˆæ™®é€šï¼‰

    // iOS Safari å¯¾å¿œã®ãŸã‚ã€å†ç”Ÿå‰ã« stop() ã‚’å‘¼ã¶ã¨å®‰å®šã™ã‚‹
    window.speechSynthesis.cancel();
    window.speechSynthesis.speak(utterance);
}
</script>
<body>
    <h2>ğŸ§  å˜èªå¸³ç”ŸæˆAIã‚¢ãƒ—ãƒª</h2>
    <form method="POST">
        <textarea name="english_text" rows="8" cols="60">{{ user_input }}</textarea><br>
        <button type="submit">â–¶ï¸ å˜èªå¸³ã‚’ç”Ÿæˆã™ã‚‹</button>
    </form>

    {% if vocab_list %}
    <h3>ğŸ“˜ ç”Ÿæˆã•ã‚ŒãŸå˜èªå¸³ï¼š</h3>
    <a href="/download_csv">
    <button>â¬‡ï¸ CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
    </a>
    <table border="1">
    <tr><th>å˜èª</th><th>æ„å‘³</th><th>ä¾‹æ–‡</th><th>éŸ³å£°</th></tr>
    {% for item in vocab_list %}
    <tr>
        <td>{{ item.word }}</td>
        <td>{{ item.meaning }}</td>
        <td>{{ item.example }}</td>
        <td><button onclick="speak('{{ item.word }}')">ğŸ”ˆ</button></td>
    </tr>
    {% endfor %}
</table>

    {% endif %}

{% if history %}
<h3>ğŸ“œ å±¥æ­´ï¼ˆæœ€å¤§10ä»¶ï¼‰ï¼š</h3>
{% for item in history[:10] %}
<div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
    <form method="POST" action="/delete/{{ loop.index0 }}" style="float:right;">
        <button type="submit" onclick="return confirm('ã“ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">ğŸ—‘</button>
    </form>
    <strong>å…¥åŠ›æ–‡ï¼š</strong><br>{{ item.input }}<br><br>
    <table border="1">
        <tr><th>å˜èª</th><th>æ„å‘³</th><th>ä¾‹æ–‡</th></tr>
        {% for v in item.vocab %}
        <tr>
            <td>{{ v.word }}</td>
            <td>{{ v.meaning }}</td>
            <td>{{ v.example }}</td>
        </tr>
        {% endfor %}
    </table>
</div>
{% endfor %}

<form method="POST" action="/delete_all">
    <button type="submit" onclick="return confirm('å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">âŒ å±¥æ­´ã‚’ã™ã¹ã¦å‰Šé™¤</button>
</form>
{% endif %}
</body>
</html>
